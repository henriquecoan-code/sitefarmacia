<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administra√ß√£o de Produtos</title>
  <link rel="stylesheet" href="css/estilo.css">
  <link rel="stylesheet" href="css/account-styles.css">
  <style>
    .produtos-container { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
    .produto-card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 1rem; width: 260px; display: flex; flex-direction: column; align-items: center; }
    .produto-card img { max-width: 120px; max-height: 120px; margin-bottom: 0.5rem; }
    .produto-card h3 { margin: 0.5rem 0 0.2rem 0; font-size: 1.1rem; }
    .produto-card p { margin: 0.2rem 0; font-size: 0.95rem; }
    .filtros { margin: 1.5rem 0 1rem 0; display: flex; gap: 1rem; flex-wrap: wrap; }
    .filtros input, .filtros select { padding: 0.4rem; border-radius: 4px; border: 1px solid #ccc; }
    .upload-area { margin: 2rem 0 1rem 0; }
    .upload-area input[type="file"] { display: none; }
    .upload-label { background: #1976d2; color: #fff; padding: 0.7rem 1.5rem; border-radius: 5px; cursor: pointer; font-weight: bold; }
    .upload-label:hover { background: #125ea2; }
    .status-msg { margin-top: 0.5rem; font-size: 0.95rem; }
  </style>
</head>
<body>
  <div id="header-container"></div>
  <main class="container">
    <h1>Administra√ß√£o de Produtos</h1>
    <section class="upload-area">
      <label class="upload-label" for="csv-upload">üì§ Fazer upload de produtos (.csv)</label>
      <input type="file" id="csv-upload" accept=".csv">
      <div class="status-msg" id="upload-status"></div>
      <a href="produtos-modelo.csv" download style="font-size:0.95rem;display:block;margin-top:0.5rem;">Baixar modelo de planilha</a>
    </section>
    <section class="filtros">
      <input type="text" id="filtro-nome" placeholder="Pesquisar por nome...">
      <select id="filtro-categoria">
        <option value="">Todas as categorias</option>
      </select>
    </section>
    <section>
      <div class="produtos-container" id="produtos-lista"></div>
    </section>
  </main>
  <div id="footer-container"></div>
  <script type="module" src="js/load-components.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';
    import { loadHeader } from './js/header-loader.js';
    import { loadFooter } from './js/footer-loader.js';
    import { firebaseConfig } from './js/firebase-config.js';
    const app = window.firebaseApp || (window.firebaseApp = initializeApp(firebaseConfig));
    const auth = getAuth(app);
    const db = getFirestore(app);
    window.auth = auth;
    await loadHeader('header-container', 'authContainerSecondary');
    await loadFooter('footer-container');

    let produtos = [];
    let categorias = new Set();

    async function carregarProdutos() {
      const lista = document.getElementById('produtos-lista');
      lista.innerHTML = '<div>Carregando produtos...</div>';
      produtos = [];
      categorias.clear();
      const snap = await getDocs(collection(db, 'produtos'));
      snap.forEach(doc => {
        const data = doc.data();
        produtos.push({ id: doc.id, ...data });
        if (data.categoria) categorias.add(data.categoria);
      });
      atualizarCategorias();
      renderizarProdutos();
    }

    function atualizarCategorias() {
      const select = document.getElementById('filtro-categoria');
      const valorAtual = select.value;
      select.innerHTML = '<option value="">Todas as categorias</option>';
      Array.from(categorias).sort().forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        select.appendChild(opt);
      });
      select.value = valorAtual;
    }

    function renderizarProdutos() {
      const lista = document.getElementById('produtos-lista');
      const nomeFiltro = document.getElementById('filtro-nome').value.toLowerCase();
      const catFiltro = document.getElementById('filtro-categoria').value;
      let filtrados = produtos.filter(p =>
        (!nomeFiltro || (p.nome && p.nome.toLowerCase().includes(nomeFiltro))) &&
        (!catFiltro || p.categoria === catFiltro)
      );
      if (filtrados.length === 0) {
        lista.innerHTML = '<div style="color:#888">Nenhum produto encontrado.</div>';
        return;
      }
      lista.innerHTML = '';
      filtrados.forEach(prod => {
        const card = document.createElement('div');
        card.className = 'produto-card';
        card.innerHTML = `
          <img src="${prod.fotos && prod.fotos[0] ? prod.fotos[0] : 'img/medicamento.png'}" alt="${prod.nome}">
          <h3>${prod.nome || ''}</h3>
          <p><b>Categoria:</b> ${prod.categoria || '-'}</p>
          <p><b>Pre√ßo:</b> R$ ${prod.precoMaximo ? prod.precoMaximo.toFixed(2) : '-'}</p>
          <p><b>Desconto:</b> ${prod.desconto ? (prod.desconto * 100).toFixed(0) + '%' : '-'}</p>
        `;
        lista.appendChild(card);
      });
    }

    document.getElementById('filtro-nome').addEventListener('input', renderizarProdutos);
    document.getElementById('filtro-categoria').addEventListener('change', renderizarProdutos);

    // Fun√ß√£o para parsear CSV simples (assume separador ; ou ,)
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      if (lines.length < 2) return [];
      const sep = lines[0].includes(';') ? ';' : ',';
      const headers = lines[0].split(sep).map(h => h.trim());
      return lines.slice(1).map(line => {
        const cols = line.split(sep);
        const obj = {};
        headers.forEach((h, i) => obj[h] = (cols[i]||'').trim());
        return obj;
      });
    }

    document.getElementById('csv-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const status = document.getElementById('upload-status');
      status.textContent = 'Lendo arquivo...';
      try {
        const text = await file.text();
        const produtosCSV = parseCSV(text);
        if (!produtosCSV.length) throw new Error('CSV vazio ou inv√°lido');
        status.textContent = 'Salvando produtos no Firestore...';
        let count = 0;
        for (const prod of produtosCSV) {
          // Convers√£o e valida√ß√£o b√°sica
          if (!prod.nome || !prod.precoMaximo) continue;
          const precoMaximo = parseFloat(prod.precoMaximo.replace(',', '.'));
          const desconto = prod.desconto ? parseFloat(prod.desconto.replace(',', '.')) : 0;
          const valorComDesconto = precoMaximo * (1 - desconto);
          const quantidade = prod.quantidade ? parseInt(prod.quantidade, 10) : 0;
          const tags = prod.tags ? prod.tags.split(',').map(t => t.trim()) : [];
          const fotos = prod.fotos ? prod.fotos.split(',').map(f => f.trim()) : [];
          await addDoc(collection(db, 'produtos'), {
            nome: prod.nome,
            descricao: prod.descricao || '',
            precoMaximo,
            desconto,
            valorComDesconto,
            quantidade,
            categoria: prod.categoria || '',
            subcategoria: prod.subcategoria || '',
            tags,
            fotos,
            criadoEm: new Date()
          });
          count++;
        }
        status.textContent = `Importa√ß√£o conclu√≠da: ${count} produto(s) salvo(s)!`;
        await carregarProdutos();
      } catch (err) {
        status.textContent = 'Erro ao importar: ' + err.message;
      }
      setTimeout(() => { status.textContent = ''; }, 4000);
    });

    carregarProdutos();
  </script>
</body>
</html>
