        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            
          const form = document.getElementById('registrationForm');
          const submitButton = document.getElementById('submitButton');
          const loadingOverlay = document.getElementById('loadingOverlay');
          const cpfInput = document.getElementById('cpf');
          const phoneInput = document.getElementById('phone');
          const errorFields = [
              'fullNameError', 'emailError', 'passwordError', 'cpfError', 'phoneError', 'enderecoError', 'termsError'
          ];

          // Esconde erro ao digitar
          ['fullName','email','password','cpf','phone','rua','numero','bairro','cidade','terms'].forEach(id => {
              const el = document.getElementById(id);
              if (el) {
                  el.addEventListener('input', () => {
                      const errorEl = document.getElementById(id + 'Error');
                      if (errorEl) errorEl.classList.add('hidden');
                  });
              }
          });

          cpfInput.addEventListener('input', function() {
            this.value = formatCpfCnpj(this.value);
          });
          phoneInput.addEventListener('input', function() {
            this.value = formatPhone(this.value);
          });
          form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const fullName = document.getElementById('fullName').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const cpfRaw = document.getElementById('cpf').value.replace(/\D/g, '');
            const phone = document.getElementById('phone').value.replace(/\D/g, '');
            const terms = document.getElementById('terms').checked;
            const rua = document.getElementById('rua').value.trim();
            const numero = document.getElementById('numero').value.trim();
            const bairro = document.getElementById('bairro').value.trim();
            const cidade = document.getElementById('cidade').value.trim();
            const complemento = document.getElementById('complemento').value.trim();

            // Ajuste: Aceitar CPF (11) ou CNPJ (14) dígitos
            if (!fullName || !email || !password || !(cpfRaw.length === 11 || cpfRaw.length === 14) || phone.length < 10 || !terms || !rua || !numero || !bairro || !cidade) {
                setFieldError('fullNameError', !fullName);
                setFieldError('emailError', !email);
                setFieldError('passwordError', password.length < 6);
                setFieldError('cpfError', !(cpfRaw.length === 11 || cpfRaw.length === 14));
                setFieldError('phoneError', phone.length < 10);
                setFieldError('enderecoError', !(rua && numero && bairro && cidade));
                setFieldError('termsError', !terms);
                showToast('Por favor, preencha todos os campos corretamente', 'error');
                focusFirstInvalid(errorFields);
                return;
            }

            const emailRegex = /^[\w-.]+@[\w-]+\.[a-zA-Z]{2,}$/;
            if (!emailRegex.test(email)) {
                setFieldError('emailError', true);
                showToast('Por favor, insira um e-mail válido', 'error');
                document.getElementById('email').focus();
                return;
            }

            // Validação do domínio ANTES de criar o usuário
            const allowedDomains = [
                'gmail.com', 'hotmail.com', 'outlook.com', 'yahoo.com', 'icloud.com', 'bol.com.br', 'uol.com.br', 'live.com'
            ];
            const emailDomain = email.split('@')[1]?.toLowerCase();
            if (!allowedDomains.includes(emailDomain)) {
                showToast('Apenas e-mails tradicionais são permitidos.', 'error');
                document.getElementById('email').focus();
                return;
            }

            // Validação CPF/CNPJ
            if (!(cpfRaw.length === 11 || cpfRaw.length === 14)) {
                setFieldError('cpfError', true);
                showToast('Por favor, insira um CPF ou CNPJ válido', 'error');
                document.getElementById('cpf').focus();
                return;
            } else {
                setFieldError('cpfError', false);
            }

            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="loader mr-2"></span>Processando...';
            loadingOverlay.style.display = 'flex';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: fullName });
                // Salva dados principais do usuário (sem campo 'endereco')
                await setDoc(doc(firestore, 'usuarios', userCredential.user.uid), {
                    nome: fullName,
                    email: email,
                    cpf: cpfRaw,
                    telefone: phone,
                    role: "user",
                    dataCadastro: new Date().toISOString(),
                    emailVerificado: false
                });
                // Salva o endereço inicial na subcoleção 'enderecos'
                const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js');
                const enderecosCol = collection(firestore, 'usuarios', userCredential.user.uid, 'enderecos');
                await addDoc(enderecosCol, {
                    cep: '', // Se quiser adicionar campo de CEP no cadastro, ajuste aqui
                    rua: rua,
                    numero: numero,
                    bairro: bairro,
                    cidade: cidade,
                    complemento: complemento,
                    telefone: phone,
                    criadoEm: new Date().toISOString()
                });
                showToast('Cadastro realizado! Verifique seu e-mail para ativar a conta.', 'success');
                await signOut(auth);
                setTimeout(() => {
                  window.location.href = 'login.html';
                }, 2000);
            } catch (error) {
                let errorMessage = 'Erro no cadastro: ';
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = 'Este e-mail já está cadastrado';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'A senha deve ter pelo menos 6 caracteres';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'E-mail inválido';
                        break;
                    default:
                        errorMessage += error.message;
                }
                showToast(errorMessage, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Cadastrar';
                loadingOverlay.style.display = 'none';
            }
          });
        });
        </script>