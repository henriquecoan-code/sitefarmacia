<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmácia Online - Carrinho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .skeleton { animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="header-container"></div>
    <main class="container mx-auto px-4 py-8">
        <h2 class="text-3xl font-bold text-blue-900 mb-8">Meu Carrinho</h2>
        <div id="cart-list" class="space-y-6"></div>
        <div id="cart-total" class="text-right mt-8 text-2xl font-bold text-blue-900"></div>
        <div id="empty-cart" class="text-center text-gray-500 mt-16 hidden">
            <i class="fas fa-shopping-cart text-5xl mb-4"></i>
            <p>Seu carrinho está vazio.</p>
        </div>
        <div class="mt-12">
            <h3 class="text-xl font-bold text-blue-900 mb-4">Informações do Pedido</h3>
            <div id="enderecos-container" class="mb-2">
                <label for="endereco-select" class="block mb-1 font-semibold">Endereço de Entrega</label>
                <select id="endereco-select" class="border p-2 w-full rounded"></select>
            </div>
            <textarea id="observacoes" placeholder="Observações (opcional)" class="border p-2 w-full mb-2 rounded"></textarea>
            <select id="pagamento" class="border p-2 w-full mb-4 rounded">
                <option value="">Forma de Pagamento</option>
                <option value="Pix">Pix</option>
                <option value="Cartão">Cartão</option>
                <option value="Dinheiro">Dinheiro</option>
            </select>
        </div>
        <div class="mt-8 flex justify-end gap-4">
            <button id="limpar-carrinho" class="bg-gray-300 text-gray-800 px-6 py-3 rounded hover:bg-gray-400 transition font-bold">Limpar Carrinho</button>
            <button id="finalizar-compra" class="bg-blue-700 text-white px-6 py-3 rounded hover:bg-blue-800 transition font-bold" disabled>Finalizar Compra</button>
        </div>
    </main>
    <div id="footer-container"></div>
    <script>
        // Set the base URL dynamically based on the environment
        window.BASE_URL = window.location.origin.includes('localhost') ? 'http://localhost:3000' : 'https://your-production-url.com';
    </script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';
        import { loadHeader } from './js/header-loader.js';
        import { loadFooter } from './js/footer-loader.js';
        import { firebaseConfig } from './js/firebase-config.js';
        const app = window.firebaseApp || (window.firebaseApp = initializeApp(firebaseConfig));
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.auth = auth;
        await loadHeader('header-container', 'authContainerSecondary');
        await loadFooter('footer-container');

        // Função para carregar endereços do usuário (corrigida para usar auth/db do módulo)
        async function carregarEnderecosUsuario() {
            const { collection, doc, getDoc, getDocs } = await import('https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js');
            const enderecoSelect = document.getElementById('endereco-select');
            enderecoSelect.innerHTML = '<option value="">Carregando endereços...</option>';
            let enderecos = [];
            let principal = null;
            let user = null;
            // Aguarda autenticação
            await new Promise(resolve => {
                const unsub = auth.onAuthStateChanged(u => { user = u; unsub(); resolve(); });
            });
            if (!user) {
                enderecoSelect.innerHTML = '<option value="">Faça login para selecionar endereço</option>';
                enderecoSelect.disabled = true;
                return;
            }
            // Busca subcoleção de endereços (modular)
            const subRef = collection(db, 'usuarios', user.uid, 'enderecos');
            const subSnap = await getDocs(subRef);
            subSnap.forEach(docSnap => {
                const data = docSnap.data();
                enderecos.push({ id: docSnap.id, ...data });
            });
            // Busca campo principal do doc, se não houver nenhum endereço principal na subcoleção
            const docUserRef = doc(db, 'usuarios', user.uid);
            const docUserSnap = await getDoc(docUserRef);
            if (docUserSnap.exists() && docUserSnap.data().endereco) {
                principal = docUserSnap.data().endereco;
            }
            // Ordena: principal=true primeiro, depois os outros
            enderecos.sort((a, b) => (b.principal === true) - (a.principal === true));
            enderecoSelect.innerHTML = '';
            if (enderecos.length > 0) {
                enderecos.forEach((e, idx) => {
                    let txt = `${e.rua || ''}, ${e.numero || ''} - ${e.bairro || ''}, ${e.cidade || ''}${e.complemento ? ' ('+e.complemento+')' : ''}`;
                    enderecoSelect.innerHTML += `<option value="${e.id}">${e.principal ? '[Principal] ' : ''}${txt}</option>`;
                });
            } else if (principal) {
                let txt = `${principal.rua || ''}, ${principal.numero || ''} - ${principal.bairro || ''}, ${principal.cidade || ''}${principal.complemento ? ' ('+principal.complemento+')' : ''}`;
                enderecoSelect.innerHTML = `<option value="principal-doc">${txt}</option>`;
            } else {
                enderecoSelect.innerHTML = '<option value="">Nenhum endereço cadastrado</option>';
                enderecoSelect.disabled = true;
            }
        }

        // Carrega endereços do usuário após header/footer e Firebase prontos
        // Aguarda autenticação antes de carregar endereços
        function aguardarUsuarioECarregarEnderecos() {
            const unsubscribe = auth.onAuthStateChanged(user => {
                if (user) {
                    carregarEnderecosUsuario();
                } else {
                    // Se não autenticado, limpa o select
                    const enderecoSelect = document.getElementById('endereco-select');
                    if (enderecoSelect) {
                        enderecoSelect.innerHTML = '<option value="">Faça login para selecionar endereço</option>';
                        enderecoSelect.disabled = true;
                    }
                }
                unsubscribe(); // Garante que só executa uma vez
            });
        }

        aguardarUsuarioECarregarEnderecos();

        let cart = [];
        let unsubscribeCart = null;

        async function renderCart() {
            const cartList = document.getElementById('cart-list');
            const cartTotal = document.getElementById('cart-total');
            const emptyCart = document.getElementById('empty-cart');
            const finalizarBtn = document.getElementById('finalizar-compra');
            cartList.innerHTML = '';
            let total = 0;
            if (!cart || cart.length === 0) {
                emptyCart.classList.remove('hidden');
                cartTotal.textContent = '';
                finalizarBtn.disabled = true;
                finalizarBtn.classList.add('opacity-50', 'cursor-not-allowed');
                return;
            } else {
                emptyCart.classList.add('hidden');
                finalizarBtn.disabled = false;
                finalizarBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            cart.forEach((item, idx) => {
                const subtotal = item.quantidade * (item.valorComDesconto || item.precoMaximo || 0);
                total += subtotal;
                const el = document.createElement('div');
                el.className = "flex flex-col md:flex-row items-center bg-white rounded-xl shadow-lg p-4 gap-6 border border-gray-100 hover:shadow-2xl transition-all duration-200";
                const imgUrl = (item.fotos && item.fotos.length > 0 && item.fotos[0]) ? item.fotos[0] : '/img/medicamento.png';
                el.innerHTML = `
                    <img src="${imgUrl}"
                        alt="${item.nome}"
                        class="w-28 h-28 object-contain rounded bg-gray-100 border border-gray-200 shadow-sm mb-2 md:mb-0"
                        onerror="this.onerror=null;this.src='/img/medicamento.png';">
                    <div class="flex-1 w-full flex flex-col justify-between">
                        <div>
                            <h3 class="font-semibold text-lg text-blue-900">${item.nome}</h3>
                            <p class="text-gray-500 text-sm mb-2 line-clamp-2">${item.descricao || ''}</p>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <button class="bg-gray-200 px-3 py-1 rounded text-lg font-bold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Diminuir quantidade" onclick="updateQty(${idx}, -1)">-</button>
                            <span class="mx-2 min-w-[32px] text-center text-base font-medium">${item.quantidade}</span>
                            <button class="bg-gray-200 px-3 py-1 rounded text-lg font-bold hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Aumentar quantidade" onclick="updateQty(${idx}, 1)">+</button>
                            <span class="ml-4 text-blue-700 font-bold text-base">R$ ${(item.valorComDesconto || item.precoMaximo).toFixed(2)}</span>
                            <button class="ml-6 text-red-600 hover:text-red-800 transition-colors px-2 py-1 rounded focus:outline-none focus:ring-2 focus:ring-red-400" aria-label="Remover item" onclick="removeItem(${idx})">
                                <i class="fas fa-trash"></i> <span class="hidden md:inline">Remover</span>
                            </button>
                        </div>
                    </div>
                    <div class="text-right font-bold text-lg w-32 min-w-[120px] text-blue-900">
                        Subtotal:<br><span class="text-xl">R$ ${subtotal.toFixed(2)}</span>
                    </div>
                `;
                cartList.appendChild(el);
            });
            cartTotal.innerHTML = `<span class="text-gray-700">Total:</span> <span class="text-3xl text-blue-900 font-extrabold">R$ ${total.toFixed(2)}</span>`;
        }

        async function loadCart() {
            // Usa Firestore se logado, senão localStorage
            const currentUser = await new Promise(resolve => {
                const unsub = auth.onAuthStateChanged(u => { unsub(); resolve(u); });
            });
            if (currentUser && window.getCartFromFirestore) {
                // MIGRAÇÃO: garante que o carrinho local seja migrado ao logar
                await migrateLocalCartToFirestoreIfNeeded(currentUser);
                // onSnapshot para atualização em tempo real
                if (unsubscribeCart) unsubscribeCart();
                unsubscribeCart = window.listenCartCount(currentUser.uid, (cartData) => {
                    cart = Array.isArray(cartData) ? cartData : (cartData && Array.isArray(cartData.itens) ? cartData.itens : []);
                    renderCart();
                }, true); // true = retorna array completo
            } else {
                cart = JSON.parse(localStorage.getItem('cart')) || [];
                renderCart();
            }
        }

        // Função para migrar carrinho local para Firestore ao login
        async function migrateLocalCartToFirestoreIfNeeded(user) {
            if (!user || !window.saveCartToFirestore) return;
            const localCart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (!localCart.length) return;
            // Busca o carrinho atual do Firestore
            let firestoreCart = [];
            try {
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js');
                const cartDoc = await getDoc(doc(db, 'carrinhos', user.uid));
                if (cartDoc.exists() && Array.isArray(cartDoc.data().itens)) {
                    firestoreCart = cartDoc.data().itens;
                }
            } catch (e) {}
            // Mescla os itens: soma quantidades de produtos iguais (pelo id ou nome)
            const mergedCart = [...firestoreCart];
            localCart.forEach(localItem => {
                const idx = mergedCart.findIndex(item => item.id === localItem.id || item.nome === localItem.nome);
                if (idx >= 0) {
                    mergedCart[idx].quantidade = (mergedCart[idx].quantidade || 1) + (localItem.quantidade || 1);
                } else {
                    mergedCart.push(localItem);
                }
            });
            await window.saveCartToFirestore(user.uid, mergedCart);
            localStorage.removeItem('cart');
        }

        async function updateQty(idx, delta) {
            const currentUser = auth.currentUser;
            if (currentUser && window.saveCartToFirestore) {
                let newCart = [...cart];
                if (newCart[idx]) {
                    newCart[idx].quantidade += delta;
                    if (newCart[idx].quantidade < 1) newCart[idx].quantidade = 1;
                    await window.saveCartToFirestore(currentUser.uid, newCart);
                }
            } else {
                if (cart[idx]) {
                    cart[idx].quantidade += delta;
                    if (cart[idx].quantidade < 1) cart[idx].quantidade = 1;
                    localStorage.setItem('cart', JSON.stringify(cart));
                    renderCart();
                }
            }
        }

        async function removeItem(idx) {
            const currentUser = auth.currentUser;
            if (currentUser && window.saveCartToFirestore) {
                let newCart = [...cart];
                newCart.splice(idx, 1);
                await window.saveCartToFirestore(currentUser.uid, newCart);
            } else {
                cart.splice(idx, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCart();
            }
        }

        async function limparCarrinho() {
            const currentUser = auth.currentUser;
            if (currentUser && window.saveCartToFirestore) {
                await window.saveCartToFirestore(currentUser.uid, []);
            } else {
                cart = [];
                localStorage.setItem('cart', JSON.stringify(cart));
                renderCart();
            }
        }

        document.getElementById('limpar-carrinho').addEventListener('click', limparCarrinho);

        // Função para finalizar a compra
        document.getElementById('finalizar-compra').addEventListener('click', async () => {
            const { collection, doc, getDoc, getDocs, addDoc } = await import('https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js');
            // Validação obrigatória da forma de pagamento
            const pagamento = document.getElementById('pagamento').value;
            if (!['Pix','Cartão','Dinheiro'].includes(pagamento)) {
                alert('Por favor, selecione a forma de pagamento.');
                document.getElementById('pagamento').focus();
                return;
            }
            // Aguarda o estado de autenticação estar pronto antes de prosseguir
            const user = await getCurrentUser();
            if (!user) {
                alert('Você precisa estar logado para finalizar a compra.');
                return;
            }
            // Carregar endereços e pegar selecionado
            const enderecoSelect = document.getElementById('endereco-select');
            let endereco = { rua: '', numero: '', bairro: '', cidade: '', complemento: '' };
            let enderecoId = enderecoSelect && enderecoSelect.value;
            if (!enderecoId) {
                alert('Selecione um endereço de entrega.');
                return;
            }
            if (enderecoId === 'principal-doc') {
                // Buscar campo principal do doc
                const docUserRef = doc(db, 'usuarios', user.uid);
                const docUserSnap = await getDoc(docUserRef);
                if (docUserSnap.exists() && docUserSnap.data().endereco) {
                    endereco = docUserSnap.data().endereco;
                } else {
                    alert('Endereço principal não encontrado.');
                    return;
                }
            } else {
                // Buscar endereço na subcoleção
                const docEndRef = doc(db, 'usuarios', user.uid, 'enderecos', enderecoId);
                const docEndSnap = await getDoc(docEndRef);
                if (docEndSnap.exists()) {
                    endereco = docEndSnap.data();
                } else {
                    alert('Endereço selecionado não encontrado.');
                    return;
                }
            }
            // Buscar nome, telefone e email do usuário autenticado
            let nomeUsuario = '';
            let telefone = '';
            let emailUsuario = '';
            if (user.displayName) nomeUsuario = user.displayName;
            if (user.email) emailUsuario = user.email;
            try {
                const docUserRef = doc(db, 'usuarios', user.uid);
                const docUserSnap = await getDoc(docUserRef);
                if (docUserSnap.exists()) {
                    const data = docUserSnap.data();
                    if (data.nome) nomeUsuario = data.nome;
                    if (data.telefone) telefone = data.telefone;
                }
            } catch (e) {}
            const observacoes = document.getElementById('observacoes').value;
            // Busca o carrinho do Firestore
            let cartPedido = [];
            const cartSnap = await getDoc(doc(db, 'carrinhos', user.uid));
            if (cartSnap.exists() && Array.isArray(cartSnap.data().itens)) {
                cartPedido = cartSnap.data().itens;
            }
            if (!cartPedido.length) {
                alert('Seu carrinho está vazio!');
                return;
            }
            let total = 0;
            const produtos = cartPedido.map(item => {
                const preco = item.valorComDesconto || item.precoMaximo || 0;
                const subtotal = preco * item.quantidade;
                total += subtotal;
                return {
                    nome: item.nome,
                    quantidade: item.quantidade,
                    valor: preco.toFixed(2),
                    subtotal: subtotal.toFixed(2)
                };
            });
            // Gera número de pedido crescente
            let lastOrderNumber = parseInt(localStorage.getItem('lastOrderNumber') || '0', 10);
            lastOrderNumber += 1;
            localStorage.setItem('lastOrderNumber', lastOrderNumber);
            const numeroPedido = lastOrderNumber;
            const dataPedido = new Date().toLocaleString('pt-BR');
            // Salva o pedido no Firestore (modular)
            try {
                await addDoc(collection(db, 'pedidos'), {
                    numeroPedido,
                    dataPedido,
                    userId: user.uid,
                    nomeUsuario,
                    emailUsuario,
                    telefone,
                    endereco,
                    observacoes,
                    pagamento,
                    produtos,
                    total: total.toFixed(2),
                    status: 'Pendente'
                });
            } catch (e) {
                alert('Erro ao salvar pedido no servidor.');
                return;
            }
            // Exibe mensagem de pedido concluído
            const main = document.querySelector('main');
            main.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-[60vh]">
                    <i class="fas fa-check-circle text-green-500 text-6xl mb-6"></i>
                    <h2 class="text-3xl font-bold text-green-700 mb-4">Pedido realizado com sucesso!</h2>
                    <p class="text-lg text-gray-700 mb-2">Seu pedido foi enviado para a farmácia e está sendo processado.</p>
                    <p class="text-md text-gray-600 mb-6">Você receberá atualizações pelo WhatsApp ou poderá acompanhar pelo painel de pedidos.</p>
                    <a href="index.html" class="mt-4 px-6 py-3 bg-blue-700 text-white rounded font-bold hover:bg-blue-800 transition">Voltar para a Home</a>
                </div>
            `;
            // Limpa o carrinho
            const currentUser = auth.currentUser;
            if (currentUser && window.saveCartToFirestore) {
                await window.saveCartToFirestore(currentUser.uid, []);
            } else {
                localStorage.removeItem('cart');
            }
        });
        // Migração automática do carrinho local para Firestore ao login
        async function migrateLocalCartToFirestoreIfNeeded(user) {
            if (!user || !window.saveCartToFirestore) return;
            const localCart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (!localCart.length) return;
            // Busca o carrinho atual do Firestore
            let firestoreCart = [];
            try {
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js');
                const cartDoc = await getDoc(doc(db, 'carrinhos', user.uid));
                if (cartDoc.exists() && Array.isArray(cartDoc.data().itens)) {
                    firestoreCart = cartDoc.data().itens;
                }
            } catch (e) {}
            // Mescla os itens: soma quantidades de produtos iguais (pelo id ou nome)
            const mergedCart = [...firestoreCart];
            localCart.forEach(localItem => {
                const idx = mergedCart.findIndex(item => item.id === localItem.id || item.nome === localItem.nome);
                if (idx >= 0) {
                    mergedCart[idx].quantidade = (mergedCart[idx].quantidade || 1) + (localItem.quantidade || 1);
                } else {
                    mergedCart.push(localItem);
                }
            });
            await window.saveCartToFirestore(user.uid, mergedCart);
            localStorage.removeItem('cart');
        }

        // Detecta login e faz migração do carrinho local
        let lastMigratedUid = null;
        auth.onAuthStateChanged(async user => {
            if (user && user.uid !== lastMigratedUid) {
                await migrateLocalCartToFirestoreIfNeeded(user);
                lastMigratedUid = user.uid;
            }
        });

        // Inicialização
        loadCart();
        window.updateQty = updateQty;
        window.removeItem = removeItem;
    </script>
    <script src="js/auth-mobile.js"></script>
</body>
</html>
